  <!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#667eea">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>La Extinci√≥n de Ad√°n - Experiencia AR</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ml5/0.12.2/ml5.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #000;
      font-family: 'Arial', sans-serif;
      overflow: hidden;
    }
    #startScreen {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex; flex-direction: column;
      justify-content: center; align-items: center;
      z-index: 1000; color: white; text-align: center;
    }
    #startScreen h1 { font-size: 2.5em; margin-bottom: 20px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
    #startScreen p { font-size: 1.2em; margin-bottom: 40px; max-width: 80%; line-height: 1.6; }
    #startBtn {
      background: linear-gradient(45deg, #ff6b6b, #ff8e53);
      border: none; padding: 20px 40px;
      font-size: 1.5em; font-weight: bold; color: white;
      border-radius: 50px; cursor: pointer; transition: all 0.3s ease;
      text-transform: uppercase; letter-spacing: 2px;
    }
    #startBtn:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(255, 107, 107, 0.4); }
    #status {
      position: fixed; top: 20px; left: 20px;
      background: rgba(0, 0, 0, 0.7); color: white;
      padding: 10px 20px; border-radius: 20px;
      font-size: 14px; z-index: 100; backdrop-filter: blur(10px);
    }
    #instructions {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7); color: white;
      padding: 10px 20px; border-radius: 20px;
      text-align: center; z-index: 100; backdrop-filter: blur(10px); font-size: 14px;
    }
    .detected { background: rgba(0, 255, 0, 0.7) !important; }
    #loadingText { margin-top: 20px; font-size: 1em; opacity: 0.8; }
  </style>
</head>
<body>
  <div id="startScreen">
    <h1>La Extinci√≥n de Ad√°n</h1>
    <p>Una experiencia de Realidad Aumentada que recrea el momento donde la creaci√≥n divina se encuentra con la destrucci√≥n c√≥smica. Enfoca la obra de arte para presenciar el apocalipsis que une el g√©nesis con el final.</p>
    <div style="margin-top: 30px; font-style: italic; opacity: 0.9; font-size: 1.1em;">‚Äî Pocho</div>
    <button id="startBtn" onclick="requestPermissionsAndStart()">Iniciar Experiencia AR</button>
    <div id="loadingText" style="display: none;">Cargando modelo de IA...</div>
  </div>

  <div id="status">üîç Buscando obra de arte...</div>
  <div id="instructions">Apunta la c√°mara hacia "La Extinci√≥n de Ad√°n"</div>

  <script>
    let video;
    let classifier;
    let label = "Buscando...";
    let confidence = 0;
    let meteorites = [];
    let isDetected = false;
    let isModelLoaded = false;
    let apocalypseStarted = false;
    let meteoritePng;
    let startTime;
    let experienceStarted = false;

    function preload() {
      meteoritePng = createGraphics(30, 30);
      meteoritePng.fill(255, 100, 0);
      meteoritePng.noStroke();
      meteoritePng.ellipse(15, 15, 20, 20);
      meteoritePng.fill(255, 200, 0);
      meteoritePng.ellipse(15, 15, 12, 12);
    }

    function requestPermissionsAndStart() {
      document.getElementById('loadingText').style.display = 'block';
      document.getElementById('loadingText').textContent = 'Solicitando acceso a la c√°mara...';
      if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
        alert('Esta experiencia requiere HTTPS para acceder a la c√°mara.');
        return;
      }
      startExperience();
    }

    function setup() {
      createCanvas(windowWidth, windowHeight);

      // üëâ URL base del modelo en GitHub Pages
      const modelURL = "https://LaPocho.github.io/la-extincion-de-adan/";

      if (typeof ml5 !== 'undefined') {
        console.log('ml5.js cargado correctamente');
        classifier = ml5.imageClassifier(modelURL + 'model.json', modelReady);
      } else {
        console.log('ml5.js no disponible');
      }
    }

    function modelReady() {
      isModelLoaded = true;
      document.getElementById('loadingText').textContent = 'Modelo de IA cargado ‚úì';
      console.log('Modelo listo para usar');
    }

    function startExperience() {
      experienceStarted = true;
      document.getElementById('startScreen').style.display = 'none';

      let constraints = {
        video: { facingMode: "environment", width: { ideal: 1280 }, height: { ideal: 720 } },
        audio: false
      };

      navigator.mediaDevices.getUserMedia(constraints)
        .then(setupVideoStream)
        .catch(err => {
          console.log('Error con c√°mara trasera:', err);
          return navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        })
        .then(stream => {
          if (stream) setupVideoStream(stream);
        })
        .catch(err => {
          console.log('Error total con c√°mara:', err);
          alert('No se pudo acceder a la c√°mara. Verifica los permisos.');
          document.getElementById('loadingText').textContent = 'Error: No se pudo acceder a la c√°mara';
        });
    }

    function setupVideoStream(stream) {
      video = document.createElement('video');
      video.setAttribute('playsinline', ''); // iOS Safari
      video.srcObject = stream;
      video.onloadedmetadata = function () {
        video.play();
        startTime = millis();
        classifyVideo();
        document.getElementById('loadingText').style.display = 'none';
      };
    }

    function draw() {
      if (!experienceStarted) return;
      background(0);

      if (video && video.readyState >= 2) {
        push();
        translate(width, 0);
        scale(-1, 1);
        image(video, 0, 0, width, height);
        pop();
      } else {
        push();
        fill(255);
        textAlign(CENTER, CENTER);
        textSize(20);
        text('Cargando c√°mara...', width/2, height/2);
        pop();
      }

      // Si se detecta la obra, crear meteoritos
      if (isDetected && confidence > 0.7) {
        if (!apocalypseStarted) {
          apocalypseStarted = true;
          updateStatus("üå† ¬°APOCALIPSIS ACTIVADO!", true);
          document.getElementById('instructions').innerHTML =
            'üí´ El momento donde la creaci√≥n divina encuentra su fin c√≥smico...';
        }
        if (frameCount % 8 === 0) meteorites.push(new Meteorite());
      } else {
        apocalypseStarted = false;
      }

      for (let i = meteorites.length - 1; i >= 0; i--) {
        meteorites[i].update();
        meteorites[i].show();
        if (meteorites[i].isOffScreen()) meteorites.splice(i, 1);
      }
    }

    function classifyVideo() {
      if (classifier && video) {
        classifier.classify(video, gotResult);
      } else {
        setTimeout(classifyVideo, 200);
      }
    }

    function gotResult(error, results) {
      if (error) {
        console.error(error);
        return;
      }
      label = results[0].label;
      confidence = results[0].confidence;

      // ‚úÖ Detecta "Obra" o "Obra 2"
      isDetected = ((label === "Obra" || label === "Obra 2") && confidence > 0.7);

      updateStatus(`${label} (${(confidence * 100).toFixed(1)}%)`, isDetected);
      classifyVideo(); // loop
    }

    function updateStatus(text, detected = false) {
      let statusEl = document.getElementById('status');
      statusEl.textContent = text;
      if (detected) statusEl.classList.add('detected');
      else statusEl.classList.remove('detected');
    }

    // === Clase Meteorite ===
    class Meteorite {
      constructor() {
        this.x = random(-50, width * 0.3);
        this.y = random(-50, height * 0.2);
        let targetX = random(width * 0.7, width + 50);
        let targetY = random(height * 0.8, height + 50);
        let angle = atan2(targetY - this.y, targetX - this.x);
        this.speed = random(3, 7);
        this.vx = cos(angle) * this.speed;
        this.vy = sin(angle) * this.speed;
        this.size = random(8, 20);
        this.rotation = random(TWO_PI);
        this.rotationSpeed = random(-0.2, 0.2);
        this.trail = [];
        this.maxTrailLength = random(8, 15);
        this.color = { r: random(200, 255), g: random(50, 150), b: random(0, 50) };
      }
      update() {
        this.x += this.vx;
        this.y += this.vy;
        this.rotation += this.rotationSpeed;
        this.trail.push({ x: this.x, y: this.y });
        if (this.trail.length > this.maxTrailLength) this.trail.splice(0, 1);
      }
      show() {
        for (let i = 0; i < this.trail.length; i++) {
          let alpha = map(i, 0, this.trail.length, 0, 200);
          let size = map(i, 0, this.trail.length, this.size * 0.2, this.size * 0.8);
          push();
          fill(this.color.r, this.color.g + 50, 0, alpha);
          noStroke();
          ellipse(this.trail[i].x, this.trail[i].y, size);
          pop();
        }
        push();
        translate(this.x, this.y);
        rotate(this.rotation);
        fill(this.color.r, this.color.g + 100, this.color.b + 100);
        noStroke();
        ellipse(0, 0, this.size);
        fill(this.color.r, this.color.g, this.color.b);
        ellipse(0, 0, this.size * 0.7);
        fill(255, 255, 200, 150);
        ellipse(-this.size * 0.2, -this.size * 0.2, this.size * 0.3);
        pop();
      }
      isOffScreen() {
        return (this.x > width + 100 || this.y > height + 100);
      }
    }

    function windowResized() {
      resizeCanvas(windowWidth, windowHeight);
    }
  </script>
</body>
</html>
